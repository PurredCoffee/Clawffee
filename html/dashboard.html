<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clawffee</title>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none"><defs>
        <symbol id="move-icon" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="none"/><rect x="54.46" y="54.46" width="147.08" height="147.08" transform="translate(-53.02 128) rotate(-45)" opacity="0.2"/><line x1="128" y1="160" x2="128" y2="232" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><line x1="128" y1="96" x2="128" y2="24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><polyline points="96 56 128 24 160 56" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><polyline points="96 200 128 232 160 200" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><line x1="96" y1="128" x2="24" y2="128" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><line x1="160" y1="128" x2="232" y2="128" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><polyline points="200 96 232 128 200 160" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><polyline points="56 96 24 128 56 160" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/>
        </symbol>
        <symbol id="pause-icon" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="none"/><rect x="152" y="40" width="56" height="176" rx="8" opacity="0.2"/><rect x="48" y="40" width="56" height="176" rx="8" opacity="0.2"/><rect x="152" y="40" width="56" height="176" rx="8" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><rect x="48" y="40" width="56" height="176" rx="8" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/>
        </symbol>
        <symbol id="play-icon" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="none"/><path d="M72,39.88V216.12a8,8,0,0,0,12.15,6.69l144.08-88.12a7.82,7.82,0,0,0,0-13.38L84.15,33.19A8,8,0,0,0,72,39.88Z" opacity="0.2"/><path d="M72,39.88V216.12a8,8,0,0,0,12.15,6.69l144.08-88.12a7.82,7.82,0,0,0,0-13.38L84.15,33.19A8,8,0,0,0,72,39.88Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/>
        </symbol>
        <symbol id="close-icon" viewBox="0 0 256 256">
            <rect width="256" height="256" fill="none"/><line x1="200" y1="56" x2="56" y2="200" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/><line x1="200" y1="200" x2="56" y2="56" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"/>
        </symbol>
    </defs></svg>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=lock,open_with" />
    <link rel="stylesheet" href="css/index.css">
    <style>
        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        a {
            color: unset;
        }
    </style>
    <script src="js/communication.js"></script>
    <script>
        function createDiv(innerHTML) {
            const div = document.createElement('div');
            div.innerHTML = innerHTML;
            return div.children[0];
        }
        const sharedServerData = katzComm.createServer({ internal: {} });
        function wrapConsoleFunction(name, copy) {
            return (...data) => {
                copy(...data);
                sharedServerData.internal[name] = data.map(arg => String(arg)).join(' ').replace('\n', '\r\n');
            }
        }

        const olddebug = console.debug;
        console.debug = wrapConsoleFunction("debug", olddebug);

        const oldlog = console.log;
        console.log = wrapConsoleFunction("log", oldlog);

        const oldinfo = console.info;
        console.info = wrapConsoleFunction("info", oldinfo);

        const oldwarn = console.warn;
        console.warn = wrapConsoleFunction("warn", oldwarn);

        const olderr = console.error;
        console.error = wrapConsoleFunction("error", olderr);
        window.onunhandledrejection = event => {
            console.error(`${event.reason}`);
        };

        window.onerror = function(message, source, lineNumber, colno, error) {
            console.error(`${message}\n${error.stack}`);
        };
        let firstmessage = null;
        let firstsubs = [];
        function onfirstSub(callback) {
            if (firstmessage) {
                callback(firstmessage);
            } else {
                firstsubs.push(callback);
            }
        }
    </script>
</head>

<body>
    <div class="modules">
        <style>
            .modules {
                border: var(--c) solid 1px;
                border-bottom-width: 3px;
                border-radius: 8px;
                margin: 8px;
                padding: 20px;
                padding-bottom: 10px;
                overflow: scroll;
            }

            #sub-modules {
                display: grid;
                position: relative;
                grid-template-columns: repeat(8, calc(100% / 8));
                grid-auto-rows: 140px;
                width: 100%;
                padding: 0;
                margin: 0;
                min-height: 700px;
                padding-bottom: 140px;
                min-width: 1000px;
                font-size: clamp(18px, 1.5vw, 40px);
            }

            #sub-modules::after {
                content: "";
                position: absolute;
                top: 0;
                bottom: 10px;
                left: 10px;
                right: 10px;
                background: linear-gradient(0deg, transparent 9px, gray 10px, transparent 10.5px),
                    linear-gradient(90deg, transparent calc(100% - 10px), gray calc(100% - 9px), transparent calc(100% - 8.5px));
                background-repeat: repeat;
                background-size: calc((100% + 20px) / 8) 140px;
                z-index: -1;
            }

            #sub-modules>* {
                border-radius: 20px;
                margin: 10px;
                margin-bottom: 20px;
                margin-top: 0;
                padding-inline: auto;
                position: relative;
                z-index: 2;
                cursor: pointer;
                user-select: none;
            }

            #sub-modules>*::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border: var(--c) 2px solid;
                border-bottom-width: 3px;
                border-radius: 20px;
                z-index: -3;
            }

            #sub-modules>*::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background:
                    linear-gradient(120deg, #09090f99, transparent),
                    linear-gradient(40deg, #010101, #0d0b0b);
                background-size: 100vw 100vh;
                background-attachment: fixed;
                filter: brightness(1000%) contrast(200%) blur(15px);
                z-index: -5;
            }

            #sub-modules>.inactive {
                background-color: #44000088;
            }

            #sub-modules>.inactive::after {
                filter: brightness(1000%) contrast(200%) blur(20px) brightness(70%);
            }

            #sub-modules>.inactive::before {
                --c: var(--e);
            }

            #sub-modules>.folder>.btn-text>span {
                text-decoration: underline;
                text-decoration-thickness: 2px;
            }

            #sub-modules>.folder>.btn-text {
                padding-bottom: 4px;
            }

            #sub-modules>.folder::before {
                border-style: double;
                border-width: 4px;
                border-bottom-width: 9px;
            }

            #sub-modules>*>.btn-text {
                position: absolute;
                top: 50%;
                left: 50%;
                translate: -50% -50%;
                width: max-content;
                max-width: calc(100%-20px);
                text-shadow: black 2px 2px 0px;
                overflow: hidden;
            }

            #sub-modules>*>.btn-action {
                position: absolute;
                bottom: 8px;
                right: 8px;
            }

            #sub-modules>*>.btn-action>button {
                background: none !important;
                border: none;
                transition: --c 0.2s ease-in-out, text-shadow 0.2s ease-in-out;
                text-shadow: transparent 2px 2px 0px;
                height: 24px;
                padding: 0.2em;
                margin-inline: 0em;
                --c: #00000000;
            }

            #sub-modules>*>.btn-bg {
                position: absolute;
                top: 8px;
                left: 8px;
                right: 8px;
                bottom: 8px;
                z-index: -4;
                border-radius: 14px;
                background-size: cover;
                background-position: 50% 50%;
                --c: #fff;
            }

            #sub-modules>.inactive>.btn-bg {
                filter: brightness(40%) hue-rotate(50deg) sepia(40%) hue-rotate(-50deg);
            }

            #sub-modules>*:hover {
                outline: rgba(var(--pr), 33%) 4px solid;
            }

            #sub-modules>*>.btn-action>button {
                box-shadow: none;
            }

            #sub-modules>*:hover>.btn-action>button {
                text-shadow: black 2px 2px 0px;
                --c: var(--P);
            }

            #sub-modules>*>.btn-action>button:hover {
                text-shadow: black 2px 2px 0px;
                --c: #fff;
            }

            #sub-modules>*>.btn-action>button.disabled {
                text-shadow: black 2px 2px 0px;
                --c: #fff;
            }

            #sub-modules>.resize>.btn-action>button {
                display: none;
            }

            #sub-modules>.resize {
                opacity: 0.5;
                cursor: nesw-resize;
            }

            #sub-modules>.move>.btn-action>button {
                display: none;
            }

            #sub-modules>.move {
                opacity: 0.5;
                cursor: move;
            }

            #cur-module {
                padding: 1em;
            }

            #commandpath>a {
                cursor: pointer;
            }

            #commandpath>a>span {
                text-decoration: underline;
            }
        </style>
        <h3 style="margin-top: 0;">Commands<span id="commandpath"></span></h3>
        <div id="sub-modules">
            <div id="module-template" template>
                <div class="btn-text" template-name></div>
                <div class="btn-action">
                    <button template-move><span class="material-symbols-outlined"><svg width="24" height="24" version="2.0">
                        <use href="#move-icon" />
                    </svg></span></button>
                    <button template-pause><span class="material-symbols-outlined"><svg width="24" height="24" version="2.0">
                        <use href="#pause-icon" template-pause-icon/>
                    </svg></span></button>
                </div>
                <div class="btn-bg" template-background></div>
            </div>
        </div>
        <div id="cur-module" style="display: none;">
            <hr info>
            <span>
                Button Settings for
                <label for="btn-name">
                    Button Name
                </label>
                <input id="btn-name" type="text">:
            </span>
            <label for="bg-upload">
                Set Background
            </label>
            <input type="file" id="bg-upload" />
        </div>
        <script>
            function lockButton(path, enable) {
                let url = new URL(enable ? "/internal/moduleLoad" : "/internal/moduleUnload", 'http://localhost:4444/');
                url.searchParams.append("path", path);
                fetch(url);
            }
            function moveButton(path, left, top, w, h) {
                for (let r = top; r < top + h; r++) {
                    for (let c = left; c < left + w; c++) {
                        if (map.has(`${r - 1},${c - 1}`)) return false;
                    }
                }
                let url = new URL("/internal/setModulePos", 'http://localhost:4444/');
                url.searchParams.append("path", path);
                url.searchParams.append("left", left);
                url.searchParams.append("top", top);
                url.searchParams.append("w", w);
                url.searchParams.append("h", h);
                fetch(url);
                return true;
            }
            const moduleParent = document.getElementById('sub-modules');
            const moduleEditor = document.getElementById('cur-module');
            let map = new Set();

            function placeModule(module) {
                let left = Math.min(8, module.conf.pos.left ?? 1);
                let w = Math.min(9 - left, module.conf.pos.w ?? 1);
                let top = module.conf.pos.top ?? 1;
                let h = module.conf.pos.h ?? 1;
                for (let r = top; r < top + h; r++) {
                    for (let c = left; c < left + w; c++) {
                        map.add(`${r - 1},${c - 1}`);
                    }
                }
            }
            function deleteModule(module) {
                let left = Math.min(8, module.conf.pos.left ?? 1);
                let w = Math.min(9 - left, module.conf.pos.w ?? 1);
                let top = module.conf.pos.top ?? 1;
                let h = module.conf.pos.h ?? 1;
                for (let r = top; r < top + h; r++) {
                    for (let c = left; c < left + w; c++) {
                        map.delete(`${r - 1},${c - 1}`);
                    }
                }
            }

            const module_template = document.getElementById('module-template');
            module_template.removeAttribute('template');
            module_template.remove();

            function addModule(name, module, left, top, w, h) {
                let moduleName = module.conf.name;
                if (!moduleName) {
                    moduleName = name.split('.js')[0];
                    moduleName = moduleName.replace(/[_\.\-]/g, ' ');
                    moduleName = moduleName.replace(/\b\w/g, c => c.toUpperCase());
                }
                let button = module_template.cloneNode(true);
                button.classList = `${module.active ? '' : 'inactive '}${Object.keys(module.children).length ? 'folder ' : ''}`;
                button.style.gridColumn = `${left} / span ${w}`;
                button.style.gridRow = `${top} / span ${h}`;
                button.querySelector('[template-pause]').classList = (module.conf.enabled ? '' : 'disabled ');
                button.querySelector('[template-pause-icon]').href.baseVal = (module.conf.enabled ? '#pause-icon' : '#play-icon');
                button.querySelector('[template-background]').style.backgroundImage = `url("images/${module.conf.img}")`;

                let path = module.path;
                let enabled = !module.conf.enabled;
                let disabled = false;

                let clickListener;
                if (Object.keys(module.children).length) {
                    clickListener = (e) => {
                        if (disabled) return;
                        modpath.push(name);
                        curPath = module.path;
                        active = "";
                        let btn = document.createElement('a');
                        let len = modpath.length - 1;
                        btn.onclick = () => {
                            modpath.length = len;
                            active = name;
                            updateModuleDisplay();
                            while (btn.parentElement.lastChild != btn) {
                                btn.parentElement.removeChild(btn.parentElement.lastChild);
                            }
                            btn.parentElement.removeChild(btn.parentElement.lastChild);
                        };
                        btn.innerHTML = "/" + `<span>${moduleName}</span>`;
                        document.getElementById('commandpath').appendChild(btn);
                        updateModuleDisplay();
                    }
                } else {
                    clickListener = (e) => {
                        active = name;
                        curPath = module.path;
                        updateModuleDisplay();
                    }
                }

                button.querySelector('[template-pause]').addEventListener('click', (event) => { lockButton(path, enabled); event.stopPropagation(); });
                button.querySelector('[template-move]').addEventListener('click', (event) => {
                    deleteModule(module);
                    button.removeEventListener('click', clickListener);
                    event.stopPropagation();
                    button.classList.add('move');
                    let col = 1;
                    let row = 1;
                    let moveFollower = (e) => {
                        const rect = moduleParent.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        const colWidth = rect.width / 8;
                        const rowHeight = 140;
                        col = Math.min(7, Math.max(0, Math.floor(x / colWidth)));
                        row = Math.max(0, Math.floor(y / rowHeight));
                        button.style.gridColumn = `${col + 1} / span 1`;
                        button.style.gridRow = `${row + 1} / span 1`;
                    }
                    moveFollower(event);
                    moduleParent.addEventListener('mousemove', moveFollower);
                    let mouseDown = (event) => {
                        event.stopPropagation();
                        button.classList.remove('move');
                        button.classList.add('resize');
                        moduleParent.removeEventListener('mousemove', moveFollower);
                        moduleParent.removeEventListener('mousedown', mouseDown);
                        let ncol = 1;
                        let nrow = 1;
                        moveFollower = (e) => {
                            const rect = moduleParent.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            const colWidth = rect.width / 8;
                            const rowHeight = 140;
                            ncol = Math.min(7, Math.max(0, Math.floor(x / colWidth)));
                            nrow = Math.max(0, Math.floor(y / rowHeight));
                            button.style.gridColumn = `${Math.min(col, ncol) + 1} / span ${Math.abs(col - ncol) + 1}`;
                            button.style.gridRow = `${Math.min(row, nrow) + 1} / span ${Math.abs(row - nrow) + 1}`;
                        }
                        moveFollower(event);
                        moduleParent.addEventListener('mousemove', moveFollower);
                        mouseDown = (e) => {
                            e.stopPropagation();
                            moduleParent.removeEventListener('mousemove', moveFollower);
                            moduleParent.removeEventListener('mouseup', mouseDown);
                            moduleParent.removeEventListener('mouseleave', mouseLeave);
                            button.classList.remove('move');
                            button.classList.remove('resize');
                            if (!moveButton(module.path, Math.min(col, ncol) + 1, Math.min(row, nrow) + 1, Math.abs(col - ncol) + 1, Math.abs(row - nrow) + 1)) {
                                button.style.gridColumn = `${left} / span ${w}`;
                                button.style.gridRow = `${top} / span ${h}`;
                                placeModule(module);
                            } else {
                                button.style.gridColumn = `${Math.min(col, ncol) + 1} / span ${Math.abs(col - ncol) + 1}`;
                                button.style.gridRow = `${Math.min(row, nrow) + 1} / span ${Math.abs(row - nrow) + 1}`;
                            }
                            setTimeout(() => button.addEventListener('click', clickListener), 500);
                        }
                        document.addEventListener('mouseup', mouseDown);
                    }
                    moduleParent.addEventListener('mousedown', mouseDown);
                    let mouseLeave = () => {
                        moduleParent.removeEventListener('mousemove', moveFollower);
                        moduleParent.removeEventListener('mousedown', mouseDown);
                        moduleParent.removeEventListener('mouseup', mouseDown);
                        moduleParent.removeEventListener('mouseleave', mouseLeave);
                        button.classList.remove('move');
                        button.classList.remove('resize');
                        button.style.gridColumn = `${left} / span ${w}`;
                        button.style.gridRow = `${top} / span ${h}`;
                        placeModule(module);
                        button.addEventListener('click', clickListener);
                    }
                    moduleParent.addEventListener('mouseleave', mouseLeave);
                });
                button.addEventListener('click', clickListener);
                moduleParent.appendChild(button);
                button.querySelector('[template-name]').innerText = Object.keys(module.children).length ? `&gt; <span>${moduleName}</span>` : moduleName;
                button.querySelector('[template-name]').style.scale = Math.min(1, (button.clientWidth - 40) / button.children[0].clientWidth);
            }

            function printModules(data) {
                moduleParent.innerHTML = "";
                map = new Set();
                let firstfree = 0;
                for (const name in data) {
                    if (Object.prototype.hasOwnProperty.call(data, name)) {
                        const module = data[name];
                        if (!module) {
                            continue;
                        }
                        if (module.conf?.pos && !module.conf?.hide) {
                            let left = Math.min(8, module.conf.pos.left ?? 1);
                            let w = Math.min(9 - left, module.conf.pos.w ?? 1);
                            let top = module.conf.pos.top ?? 1;
                            let h = module.conf.pos.h ?? 1;
                            placeModule(module);
                            addModule(name, module, left, top, w, h);
                        }
                    }
                }
                for (const name in data) {
                    if (Object.prototype.hasOwnProperty.call(data, name)) {
                        const module = data[name];
                        if (!module) {
                            continue;
                        }
                        let moduleName = `${Object.keys(module.children ?? {}).length ? ">&NonBreakingSpace;" : ""}${name.split('.js')[0]}`;
                        let style = '';
                        if (!module.conf?.pos && !module.conf?.hide) {
                            console.log(module);
                            while (map.has(`${Math.trunc(firstfree / 8)},${firstfree % 8}`)) {
                                firstfree++;
                            }
                            moveButton(module.path, Math.trunc(firstfree % 8) + 1, Math.trunc(firstfree / 8) + 1, 1, 1);
                            console.log(module);
                            return
                        }
                    }
                }
            }

            function printSettings(data) {
                if (!data) {
                    return;
                }
                let moduleName = data.conf.name;
                if (!moduleName) {
                    moduleName = (active || modpath[modpath.length - 1]).split('.js')[0];
                    moduleName = moduleName.replace(/[_\.\-]/g, ' ');
                    moduleName = moduleName.replace(/\b\w/g, c => c.toUpperCase());
                }
                document.getElementById('btn-name').value = moduleName;
                document.getElementById('btn-name').onblur = () => {
                    let url = new URL('/internal/setModuleName', 'http://localhost:4444/');
                    url.searchParams.append('path', curPath);
                    url.searchParams.append('name', event.target.value);
                    fetch(url, {
                        method: 'POST'
                    });
                };
                document.getElementById('btn-name').onkeydown = (event) => {
                    if (event.key === "Enter") {
                        event.target.onblur(event);
                    }
                }
                document.getElementById('bg-upload').onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            let url = new URL('/internal/setModuleImage', 'http://localhost:4444/');
                            url.searchParams.append('path', curPath);
                            fetch(url, {
                                method: 'POST',
                                body: JSON.stringify({
                                    image: e.target.result
                                })
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            let modpath = [];
            let active = "";
            let curPath = "";
            function updateModuleDisplay(root) {
                if(root == undefined) return;
                modpath.forEach(e => {
                    root = root.children[e] ?? root;
                });
                printModules(root.children);
                if (modpath.length && !active) {
                    moduleEditor.style.display = '';
                    printSettings(root);
                } else if (active) {
                    moduleEditor.style.display = '';
                    printSettings(root.children[active]);
                } else {
                    moduleEditor.style.display = 'none';
                }
            }

            onfirstSub((data) => {
                updateModuleDisplay(sharedServerData.internal?.loadedmodules);
            })
            const modsL = katzComm.addListener(sharedServerData, "internal.loadedmodules", (path, newData, oldData) => {
                updateModuleDisplay(sharedServerData.internal?.loadedmodules);
            });
        </script>
    </div>
    <div class="plugins">
        <h3>Plugin Settings</h3>
        <style>
            .plugins {
                padding-inline: 1em;
            }

            .plugin {
                margin-block: 1em;
                padding-inline: 1em;
                position: relative;
            }

            .plugin::before {
                content: "";
                position: absolute;
                left: -1px;
                top: 0;
                bottom: 0;
                width: 3px;
                background-color: var(--c);
                border-radius: 2px;
            }
        </style>
        <ul>
            <li>
                <details name="plugin">
                    <summary>twitch</summary>
                    <div class="plugin">
                        <h3>Twitch Settings</h3>
                        <style>
                            .usergrid {
                                display: flex;
                                gap: 1em;
                                align-items: end;
                            }

                            .usergrid>* {
                                flex-grow: 1;
                                max-width: 300px;
                                height: 100%;
                            }

                            .card {
                                padding: 1em;
                                border: 1px solid var(--c);
                                border-bottom-width: 3px;
                                border-radius: 1em;
                            }

                            .card>*>*:first-child {
                                display: flex;
                                gap: 8px;
                            }

                            .card>*>ul>li:hover {
                                --c: var(--e);
                                cursor: pointer;
                            }

                            .card img {
                                width: 48px;
                                height: 48px;
                                border-radius: 8px;
                            }

                            .redeem img {
                                height: 2em;
                                width: 2em;
                            }
                            .redeem td:first-child>div {
                                display: flex;
                                flex-direction: row;
                                justify-content: flex-start;
                                align-items: center;
                                height: 100%;
                            }
                            .redeem td:last-child>div {
                                display: flex;
                                flex-direction: row;
                                justify-content: flex-end;
                                align-items: center;
                            }
                        </style>
                        <button onclick="fetch('http://localhost:4444/twitch/add/main')">Set main user</button><button onclick="fetch('http://localhost:4444/twitch/add/bot')">Add new bot</button>
                        <div class="usergrid" id="twitch-usergrid">
                            <div id="card-template" template>
                                <h4 card-template-header></h4>
                                <div class="card">
                                    <div>
                                        <div>
                                            <img card-template-pfp src="">
                                            <div><span card-template-username></span> (<span card-template-id secondary></span>)</div>
                                        </div>
                                        <div secondary>Expires: <span card-template-expiry></span></div>
                                        <h5>
                                            Connected Channels:
                                        </h5>
                                        <ul card-template-listening>
                                        </ul>
                                        <button card-template-add-channel>Add Channel</button>
                                    </div>
                                </div>
                            </div>
                            <div id="card-template-unset" template>
                                <h4 card-template-header>Main User</h4>
                                <div class="card">
                                    <h4>No User Set!</h4>
                                    <a href="http://localhost:4444/twitch/add/main"><button card-template-add-channel>Set Main User</button></a>
                                </div>
                            </div>
                        </div>
                        <h4>Redeems</h4>
                        <button onclick="
                            document.getElementById('redeem-menu').classList.toggle('show');
                        ">View Redeems</button>
                        <menu id="redeem-menu">
                            <menubar>
                                <close-btn onclick="
                                    document.getElementById('redeem-menu').classList.toggle('show');
                                "></close-btn>
                                Redeems
                            </menubar>
                            <div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th secondary>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="twitch-redeems">
                                        <tr id="redeem-template" class="redeem" template>
                                            <td>
                                                <div>
                                                    <img style="margin-right: 1em;" src="" alt="" redeem-template-img>
                                                    <span redeem-template-name>Redeem Name</span>
                                                    &MediumSpace;(<span redeem-template-id secondary>A8734-3984-DFS3-349823</span>)
                                                </div>
                                            </td>
                                            <td secondary><span redeem-template-owned success>Owned</span></td>
                                            <td><div><button redeem-template-action-button danger>Delete</button></div></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </menu>
                        <script>
                            const twitch_template = document.getElementById("card-template");
                            twitch_template.removeAttribute("template");
                            twitch_template.remove();
                            const twitch_template_unset = document.getElementById("card-template-unset");
                            twitch_template_unset.removeAttribute("template");
                            twitch_template_unset.remove();

                            const twitchMainDiv = document.getElementById('twitch-usergrid');

                            function addTwitchUserCard(header, { id, name, pfp, listenTo, expiryDate }) {
                                const card = twitch_template.cloneNode(true);
                                card.querySelector("[card-template-header]").innerText = header;
                                card.querySelector("[card-template-pfp]").src = pfp;
                                card.querySelector("[card-template-username]").innerText = name;
                                card.querySelector("[card-template-id]").innerText = id;
                                card.querySelector("[card-template-expiry]").innerText = new Date(expiryDate).toDateString();
                                if(expiryDate < new Date().getTime() + 1000*60*60*24*14) {
                                    card.classList.add("warning");
                                    card.querySelector("[card-template-expiry]").classList.add("danger");
                                }
                                
                                const list = card.querySelector("[card-template-listening]");
                                if (Array.isArray(listenTo) && listenTo.length > 0) {
                                    listenTo.forEach(channel => {
                                        const li = document.createElement('li');
                                        li.textContent = channel;
                                        li.style.cursor = "pointer";
                                        li.title = "Click to remove";
                                        li.onclick = function () {
                                            fetch(`http://localhost:4444/twitch/removeListenTo?id=${encodeURIComponent(id)}&user=${encodeURIComponent(channel)}`, {
                                                method: 'POST'
                                            }).then(() => {
                                                li.remove();
                                            });
                                        };
                                        list.appendChild(li);
                                    });
                                }
                                card.querySelector("[card-template-add-channel]").onclick = function () {
                                    const user = prompt('Enter username to listen to:');
                                    if (user && user.trim()) {
                                        fetch(`http://localhost:4444/twitch/addListenTo?id=${encodeURIComponent(id)}&user=${encodeURIComponent(user.trim())}`, {
                                            method: 'POST'
                                        });
                                    }
                                };
                                if(expiryDate)
                                twitchMainDiv.appendChild(card);
                                return card;
                            }
                            
                            const twitch_redeem_template = document.getElementById("redeem-template");
                            twitch_redeem_template.removeAttribute("template");
                            twitch_redeem_template.remove();

                            const twitchRedeemDiv = document.getElementById('twitch-redeems');
                            
                            function addRedeem({ id, managed, title, img }) {
                                const card = twitch_redeem_template.cloneNode(true);
                                if(img)
                                    card.querySelector("[redeem-template-img]").src = img;
                                else 
                                    card.querySelector("[redeem-template-img]").remove();
                                card.querySelector("[redeem-template-name]").innerText = title;
                                card.querySelector("[redeem-template-id]").innerText = id;
                                card.querySelector("[redeem-template-owned]").innerText = managed?"Owned":"Unowned";
                                const btn = card.querySelector("[redeem-template-action-button]");
                                if(managed) {
                                    btn.innerText = "Delete";
                                    btn.classList.add("danger");
                                    btn.onclick = () => {
                                        fetch(`http://localhost:4444/twitch/deleteRedeem?${id}`);
                                    }
                                } else {
                                    btn.innerText = "Clone";
                                    btn.onclick = () => {
                                        fetch(`http://localhost:4444/twitch/cloneRedeem?${id}`);
                                    }
                                }
                                console.log(id, managed, title, img);
                            }

                            function update_twitch(data) {
                                if(!data.internal?.twitch) return;
                                twitchMainDiv.innerHTML = "";
                                if (data.internal.twitch?.main?.name)
                                    addTwitchUserCard("Main User", data.internal.twitch.main);
                                else {
                                    twitchMainDiv.appendChild(twitch_template_unset.cloneNode(true));
                                }
                                
                                let header = "Bots";
                                if (data.internal.twitch?.bots)
                                    data.internal.twitch.bots?.forEach?.((obj) => {
                                        addTwitchUserCard(header, obj);
                                        header = "";
                                    });

                                header = "Failed";
                                if (data.internal.twitch?.failed)
                                    data.internal.twitch.failed.forEach((obj) => {
                                        let card = addTwitchUserCard(header, obj);
                                        card.classList.add("danger");
                                        header = "";
                                    });

                                twitchRedeemDiv.innerHTML = "";
                                if (data.internal.twitch?.redeems)
                                    Object.keys(data.internal.twitch.redeems).sort((a,b) => {
                                        return (data.internal.twitch.redeems[a].name ?? "").localeCompare((data.internal.twitch.redeems[b].name ?? ""))
                                    }).forEach((key) => {
                                        addRedeem(data.internal.twitch.redeems[key]);
                                    });
                            }

                            onfirstSub((data) => {
                                update_twitch(sharedServerData);
                            });
                            const twitchL = katzComm.addListener(sharedServerData, "internal.twitch", (path, newData, oldData) => {
                                update_twitch(sharedServerData);
                            });
                        </script>
                    </div>
                </details>
            </li>
            <li>
                <details name="plugin">
                    <summary>html</summary>
                    <div class="plugin">
                    </div>
                </details>
            </li>
            <li>
                <details name="plugin">
                    <summary>obs</summary>
                    <div class="plugin">
                    </div>
                </details>
            </li>
        </ul>
    </div>
    <div class="log">
        <style>
            @keyframes log {
                0% {
                    opacity: 0;
                }

                5% {
                    opacity: 1;
                }

                95% {
                    opacity: 1;
                }

                100% {
                    opacity: 0;
                }
            }

            #log {
                position: fixed;
                top: 12px;
                right: 12px;
                text-align: right;
                z-index: 10000;
            }

            #log>* {
                animation: log 10s forwards;
                white-space: pre-line;
            }
        </style>
        <div id="log"></div>
        <script>
            const logParent = document.getElementById('log');
            function log(str, classList) {
                const div = document.createElement('div');
                div.textContent = str;
                div.classList = classList;
                logParent.appendChild(div);
                setTimeout(() => {
                    div.remove();
                }, 10000);
            }
            const logL = katzComm.addListener(sharedServerData, "internal.log", (path, newData, oldData) => {
                log(newData);
            });
            const errorL = katzComm.addListener(sharedServerData, "internal.error", (path, newData, oldData) => {
                log(newData, "danger");
            });
            const warnL = katzComm.addListener(sharedServerData, "internal.warn", (path, newData, oldData) => {
                log(newData, "warning");
            });
            const infoL = katzComm.addListener(sharedServerData, "internal.info", (path, newData, oldData) => {
                log(newData, "info");
            });
        </script>
    </div>
    <div class="background"></div>
    <script>
        let ws = new WebSocket("ws://localhost:4444/internal/");
        function reconnect() {
            let newWS = new WebSocket(ws.url);
            newWS.onmessage = ws.onmessage;
            newWS.onopen = ws.onopen;
            newWS.onclose = ws.onclose;
            ws = newWS;
        }
        ws.onopen = () => {
            sharedServerData.internal.info = "Connected!";
            firstmessage = null;
            ws.onclose = () => {
                sharedServerData.internal.error = "disconnected... reconnecting...";
                setTimeout(() => {
                    ws.onclose = () => {
                        setTimeout(() => {
                            reconnect();
                        }, 5000);
                    }
                    reconnect();
                }, 1000);
            }
        }
        ws.onclose = () => {
            setTimeout(() => {
                reconnect();
            }, 5000);
        }
        ws.onmessage = (message) => {
            let change = JSON.parse(message.data);
            if(change.p?.[0] != 'internal' && change.p[0])
                console.log(`data.${change.p?.join?.('.')} was set to ${JSON.stringify(change.v)}`);
            katzComm.apply(sharedServerData, change.v, change.p);
            if (!firstmessage) {
                firstmessage = change.v;
                firstsubs.forEach((c) => c(firstmessage));
            }
        }

        document.onkeydown = function(evt) {
            evt = evt || window.event;
            var isEscape = false;
            if ("key" in evt) {
                isEscape = (evt.key === "Escape" || evt.key === "Esc");
            } else {
                isEscape = (evt.keyCode === 27);
            }
            if (isEscape) {
                document.querySelectorAll('menu.show').forEach((el) => {
                    el.classList.remove("show");
                })
            }
        };
    </script>
</body>

</html>